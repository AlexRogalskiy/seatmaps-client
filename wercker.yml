build:
  box: node:8.5.0

  steps:
    - script:
        name: listing dir
        code: ls

build-dev:
  box: node:8.5.0

  steps:
    - script:
        name: install dependencies
        code: yarn
    - script:
        name: run build - includes tests
        code: yarn build-dev
    - script:
        name: copy files to the next pipeline and cleanup
        code: |
          cd $WERCKER_SOURCE_DIR
          cp -r build internals package.json .git "$WERCKER_OUTPUT_DIR"

build-prod:
  box: node:8.5.0

  steps:
    - script:
        name: install dependencies
        code: yarn
    - script:
        name: run build - includes tests
        code: yarn build
    - script:
        name: copy files to the next pipeline and cleanup
        code: |
          cd $WERCKER_SOURCE_DIR
          cp -r build internals package.json .git "$WERCKER_OUTPUT_DIR"

deploy-dev:
  box: google/cloud-sdk:latest

  steps:
    - script:
        name: upload new build to cdn & make file available publicly
        code: |
          echo -E "$GCR_JSON_KEY_FILE" > keyfile.json
          gcloud auth activate-service-account --key-file=keyfile.json
          cd /pipeline/source/build
          sudo apt-get --yes install curl
          curl -X POST --upload-file `grep -l main *.js` -H "Authorization: Bearer `gcloud auth print-access-token`" -H "Content-Type: text/javascript" "https://www.googleapis.com/upload/storage/v1/b/ticketevolution/seatmaps-dev/o?uploadType=media&name=main.js"
          cd $WERCKER_SOURCE_DIR
          curl -X POST --data-binary @internals/scripts/gcloud/public.json -H "Authorization: Bearer `gcloud auth print-access-token`" -H "Content-Type: application/json" "https://www.googleapis.com/storage/v1/b/ticketevolution/seatmaps-dev/o/main.js/acl"

deploy-production:
  box: node:boron
  steps:
    - edgecaseadmin/install-aws-cli:
        key: $AWS_KEY
        secret: $AWS_SECRET
        region: $AWS_REGION
    - script:
        name: upload new build to cdn & make file available publicly
        code: |
          cd /pipeline/source/build
          # aws s3 cp artifact.tar.gz s3://ticketevolution/maps.js
